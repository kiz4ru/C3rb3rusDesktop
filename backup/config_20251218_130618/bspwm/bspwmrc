#!/bin/bash

#############################################################
# C3rb3rusDesktop - bspwm Configuration
# La configuraci贸n principal del Window Manager
#############################################################

# Autostart - Lanzar componentes esenciales
pgrep -x sxhkd > /dev/null || sxhkd &
pgrep -x polybar > /dev/null || ~/.config/polybar/launch.sh &
pgrep -x picom > /dev/null || picom --config ~/.config/picom/picom.conf &
pgrep -x dunst > /dev/null || dunst &

# Set wallpaper (busca en orden: jpg -> png -> fallback)
WALLPAPER_DIR="$HOME/.config/bspwm/wallpapers"

if [[ -f "$WALLPAPER_DIR/wallpaper.jpg" ]]; then
    feh --bg-fill "$WALLPAPER_DIR/wallpaper.jpg"
elif [[ -f "$WALLPAPER_DIR/wallpaper.png" ]]; then
    feh --bg-fill "$WALLPAPER_DIR/wallpaper.png"
else
    # Fallback: dark gradient si no hay wallpaper
    xsetroot -solid '#0a0e14'
fi

# Cool matrix effect (opcional - comentar si no quieres)
# pgrep -x cmatrix > /dev/null || kitty --class matrix -e cmatrix -ab -u 2 &

# Workspaces - 10 escritorios virtuales
bspc monitor -d 1 2 3 4 5 6 7 8 9 10

#############################################################
# Window settings - Configuraci贸n de ventanas
#############################################################

bspc config border_width         3
bspc config window_gap          12
bspc config top_padding         38    # Espacio para Polybar
bspc config bottom_padding       5
bspc config left_padding         5
bspc config right_padding        5

#############################################################
# Colors - Cyberpunk Neon (inspirado en tu setup)
#############################################################

bspc config normal_border_color   "#1a1b26"    # Casi invisible
bspc config active_border_color   "#7aa2f7"    # Azul cyber
bspc config focused_border_color  "#00ffff"    # Cyan ne贸n
bspc config presel_feedback_color "#bb9af7"    # P煤rpura ne贸n

#############################################################
# Layout - Comportamiento de ventanas
#############################################################

bspc config split_ratio          0.52
bspc config borderless_monocle   true     # Sin bordes en monocle
bspc config gapless_monocle      true     # Sin gaps en monocle
bspc config single_monocle       false    # Mostrar borde incluso con una ventana
bspc config paddingless_monocle  true

#############################################################
# Mouse - Comportamiento del rat贸n
#############################################################

bspc config click_to_focus            true
bspc config focus_follows_pointer     true     # Foco sigue al rat贸n
bspc config pointer_follows_focus     false    # Rat贸n NO sigue al foco
bspc config pointer_follows_monitor   true
bspc config pointer_modifier          mod4     # Super para mover ventanas

#############################################################
# Rules - Reglas espec铆ficas por aplicaci贸n
#############################################################

# Herramientas de pentesting
bspc rule -a Burpsuite state=floating center=true
bspc rule -a Wireshark desktop='^6'
bspc rule -a Ghidra state=floating
bspc rule -a Metasploit state=floating

# Navegadores - Desktop 2
bspc rule -a Firefox desktop='^2'
bspc rule -a Chromium desktop='^2'
bspc rule -a Google-chrome desktop='^2'

# Desarrollo - Desktop 3
bspc rule -a Code desktop='^3'
bspc rule -a 'Sublime Text' desktop='^3'

# Comunicaci贸n - Desktop 4
bspc rule -a Slack desktop='^4'
bspc rule -a Discord desktop='^4'
bspc rule -a TelegramDesktop desktop='^4'

# Multimedia - Desktop 8
bspc rule -a Gimp desktop='^8' state=floating follow=on
bspc rule -a vlc desktop='^8'
bspc rule -a spotify desktop='^8'

# Floating por defecto
bspc rule -a Pavucontrol state=floating
bspc rule -a File-roller state=floating
bspc rule -a Lxappearance state=floating
bspc rule -a Nitrogen state=floating
bspc rule -a Arandr state=floating
bspc rule -a Gpick state=floating
bspc rule -a Font-manager state=floating

# Di谩logos y ventanas emergentes
bspc rule -a '*:*:Open File' state=floating
bspc rule -a '*:*:Save File' state=floating

#############################################################
# VPN Status Notification
#############################################################

if ip addr show tun0 &>/dev/null; then
    VPN_IP=$(ip -4 addr show tun0 | grep inet | awk '{print $2}' | cut -d/ -f1)
    notify-send " VPN Connected" "tun0: $VPN_IP" -u normal -t 5000
elif ip addr show tun1 &>/dev/null; then
    VPN_IP=$(ip -4 addr show tun1 | grep inet | awk '{print $2}' | cut -d/ -f1)
    notify-send " VPN Connected" "tun1: $VPN_IP" -u normal -t 5000
else
    notify-send "锔  No VPN" "Connect to HTB/THM" -u low -t 3000
fi

#############################################################
# Startup notification
#############################################################

sleep 2 && notify-send "C3rb3rusDesktop" "bspwm loaded successfully" -u low -t 2000 &
