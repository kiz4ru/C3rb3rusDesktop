#!/bin/bash

#############################################################
# C3rb3rusDesktop - Módulo de Herramientas
# Descripción: Instala herramientas de pentesting y VPN
#############################################################

set -euo pipefail

# Cargar funciones de logging
# SCRIPT_DIR viene de install.sh cuando se ejecuta con source

#############################################################
# Instalar meta-paquetes de Kali
#############################################################

install_kali_metapackages() {
    log_info "Instalando meta-paquetes esenciales de Kali..."
    
    local metapackages=(
        "kali-tools-top10"           # Top 10 herramientas más usadas
        "kali-tools-web"             # Herramientas para web pentesting
        "kali-tools-information-gathering"  # Recon y OSINT
        "kali-tools-vulnerability"   # Scanners de vulnerabilidades
        "kali-tools-passwords"       # Cracking de contraseñas
        "kali-tools-exploitation"    # Frameworks de explotación
    )
    
    log_warning "Esto instalará múltiples herramientas, puede tardar 10-30 minutos..."
    
    for package in "${metapackages[@]}"; do
        log_info "Instalando: $package"
        sudo apt install -y "$package" 2>&1 | grep -E "Setting up|already" || true
    done
    
    log_success "Meta-paquetes de Kali instalados"
}

#############################################################
# Instalar herramientas VPN y de red
#############################################################

install_vpn_tools() {
    log_info "Instalando herramientas VPN y de red..."
    
    local vpn_tools=(
        # Clientes VPN
        "openvpn"
        "wireguard"
        "network-manager-openvpn"
        "network-manager-openvpn-gnome"
        
        # Herramientas de red
        "nmap"
        "masscan"
        "netcat-traditional"
        "socat"
        "tcpdump"
        "wireshark"
        "tshark"
        
        # Proxies y túneles
        "proxychains4"
        "sshuttle"
        "chisel"
        
        # DNS y enumeración
        "dnsutils"
        "host"
        "whois"
        "fierce"
        "dnsenum"
        "sublist3r"
    )
    
    log_info "Instalando ${#vpn_tools[@]} herramientas de VPN/red..."
    sudo apt install -y "${vpn_tools[@]}" 2>&1 | grep -E "Setting up|already" || true
    
    # Configurar permisos para wireshark (captura sin root)
    if command -v wireshark &>/dev/null; then
        echo "wireshark-common wireshark-common/install-setuid boolean true" | \
            sudo debconf-set-selections
        sudo dpkg-reconfigure -f noninteractive wireshark-common
        sudo usermod -aG wireshark "$USER"
        log_info "Usuario agregado al grupo wireshark"
    fi
    
    log_success "Herramientas VPN instaladas"
}

#############################################################
# Instalar SecLists
#############################################################

install_seclists() {
    log_info "Instalando SecLists (wordlists para pentesting)..."
    
    local seclists_dir="/usr/share/seclists"
    
    if [[ -d "$seclists_dir" ]]; then
        log_info "SecLists ya está instalado, verificando..."
        # Verificar si es un repo git válido
        if [[ -d "$seclists_dir/.git" ]]; then
            log_info "Actualizando desde git..."
            cd "$seclists_dir" && sudo git pull 2>&1 | grep -E "Already up to date|Updating" || true
        else
            log_info "SecLists instalado via apt, omitiendo actualización git"
        fi
    else
        sudo apt install -y seclists 2>&1 | grep -E "Setting up|already" || {
            # Si no está en repos, clonar desde GitHub
            log_info "Clonando SecLists desde GitHub..."
            sudo git clone --depth 1 https://github.com/danielmiessler/SecLists.git "$seclists_dir"
        }
    fi
    
    # Crear symlink en home del usuario para acceso rápido
    if [[ ! -L "$HOME/seclists" ]]; then
        ln -s "$seclists_dir" "$HOME/seclists" 2>/dev/null || true
        log_info "Symlink creado: ~/seclists -> $seclists_dir"
    fi
    
    log_success "SecLists disponible en $seclists_dir"
}

#############################################################
# Instalar herramientas Python para pentesting
#############################################################

install_python_pentest_tools() {
    log_info "Instalando herramientas Python para pentesting..."
    
    # Asegurar que pip está actualizado
    python3 -m pip install --upgrade pip 2>&1 | grep -E "Successfully|already" || true
    
    local python_tools=(
        "pwntools"              # Framework de explotación
        "impacket"              # Herramientas para protocolos de red
        "scapy"                 # Manipulación de paquetes
        "requests"              # HTTP requests
        "beautifulsoup4"        # Web scraping
        "paramiko"              # SSH library
        "pycryptodome"          # Cryptography
        "colorama"              # Colores en terminal
        "shodan"                # Shodan API
        "censys"                # Censys API
        "python-nmap"           # Nmap wrapper
        "netaddr"               # Network address manipulation
        "dnspython"             # DNS toolkit
    )
    
    log_info "Instalando ${#python_tools[@]} paquetes Python..."
    python3 -m pip install --user "${python_tools[@]}" 2>&1 | \
        grep -E "Successfully installed|already satisfied" || true
    
    log_success "Herramientas Python instaladas"
}

#############################################################
# Instalar herramientas web adicionales
#############################################################

install_web_tools() {
    log_info "Instalando herramientas adicionales para web pentesting..."
    
    local web_tools=(
        "gobuster"              # Directory/file brute forcing
        "ffuf"                  # Web fuzzer
        "sqlmap"                # SQL injection
        "wpscan"                # WordPress scanner
        "nikto"                 # Web server scanner
        "whatweb"               # Web fingerprinting
        "burpsuite"             # Proxy/scanner (community edition)
    )
    
    sudo apt install -y "${web_tools[@]}" 2>&1 | grep -E "Setting up|already" || true
    
    log_success "Herramientas web instaladas"
}

#############################################################
# Instalar herramientas de reversing y exploiting
#############################################################

install_exploit_tools() {
    log_info "Instalando herramientas de reversing y exploiting..."
    
    local exploit_tools=(
        "gdb"                   # GNU Debugger
        "gdb-multiarch"         # GDB para múltiples arquitecturas
        "radare2"               # Framework de reversing
        "ghidra"                # NSA's reverse engineering tool
        "exploitdb"             # Exploit database
        "metasploit-framework"  # Framework de penetración
    )
    
    sudo apt install -y "${exploit_tools[@]}" 2>&1 | grep -E "Setting up|already" || true
    
    # Instalar pwndbg (plugin de GDB para CTFs)
    if [[ ! -d "$HOME/.local/share/pwndbg" ]]; then
        log_info "Instalando pwndbg (GDB enhanced para CTFs)..."
        git clone --depth 1 https://github.com/pwndbg/pwndbg "$HOME/.local/share/pwndbg"
        cd "$HOME/.local/share/pwndbg" && ./setup.sh 2>&1 | tail -5
    fi
    
    log_success "Herramientas de exploiting instaladas"
}

#############################################################
# Configurar proxychains para Tor (opcional)
#############################################################

configure_proxychains() {
    log_info "Configurando proxychains..."
    
    local proxychains_conf="/etc/proxychains4.conf"
    
    if [[ -f "$proxychains_conf" ]]; then
        # Backup
        sudo cp "$proxychains_conf" "${proxychains_conf}.backup_$(date +%Y%m%d)"
        
        # Habilitar dynamic_chain (comentar strict_chain)
        sudo sed -i 's/^strict_chain/#strict_chain/' "$proxychains_conf"
        sudo sed -i 's/^#dynamic_chain/dynamic_chain/' "$proxychains_conf"
        
        log_success "Proxychains configurado (dynamic_chain habilitado)"
    fi
}

#############################################################
# Crear directorios de trabajo para pentesting
#############################################################

create_pentest_workspace() {
    log_info "Creando estructura de trabajo para pentesting..."
    
    local pentest_dir="$HOME/pentesting"
    local subdirs=(
        "htb"           # Hack The Box
        "thm"           # TryHackMe
        "vulnhub"       # VulnHub machines
        "ctf"           # CTF challenges
        "tools"         # Custom tools
        "wordlists"     # Custom wordlists
        "scripts"       # Custom scripts
        "notes"         # Notes and documentation
        "loot"          # Extracted data
    )
    
    mkdir -p "$pentest_dir"
    
    for dir in "${subdirs[@]}"; do
        mkdir -p "$pentest_dir/$dir"
    done
    
    # Crear template para notas de HTB
    cat > "$pentest_dir/htb/TEMPLATE.md" << 'EOF'
# Machine Name: [NAME]

## Reconnaissance
- IP: 
- OS: 
- Services:

## Enumeration
```bash
# Nmap scan
nmap -sC -sV -oA nmap/initial [IP]
```

## Exploitation
- Vulnerability:
- Exploit used:
- Shell obtained:

## Privilege Escalation
- Method:
- Root obtained:

## Flags
- User: 
- Root: 

## Notes
EOF
    
    log_success "Workspace de pentesting creado en: $pentest_dir"
}

#############################################################
# Función principal
#############################################################

main() {
    echo ""
    echo "=============================================="
    echo "  Módulo Tools - Herramientas Pentesting"
    echo "=============================================="
    echo ""
    
    install_kali_metapackages
    install_vpn_tools
    install_seclists
    install_python_pentest_tools
    install_web_tools
    install_exploit_tools
    configure_proxychains
    create_pentest_workspace
    
    echo ""
    log_success "Módulo de herramientas completado exitosamente"
    log_info "Nota: Algunas herramientas requieren logout/login para permisos de grupo"
    echo ""
}

# Ejecutar si se invoca directamente
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main
fi
